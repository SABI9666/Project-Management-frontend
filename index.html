<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="manifest" href="/manifest.json" />
    <meta name="theme-color" content="#0d47a1">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EBTracker - EDANBROOK Project Management</title>
    <style>
     * { margin: 0; padding: 0; box-sizing: border-box; }

:root {
    /* Professional Light Color Palette */
    --primary-blue: #1e40af;
    --dark-blue: #1e3a8a;
    --light-blue: #dbeafe;
    --accent-blue: #3b82f6;
    --text-dark: #1f2937;
    --text-light: #6b7280;
    --background: #f0f4f8;
    --success: #10b981;
    --danger: #ef4444;
    --warning: #f59e0b;
    --border: #e5e7eb;
    --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    --card-shadow-hover: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
    background: linear-gradient(135deg, #f0f4f8 0%, #e6eef5 100%);
    color: var(--text-dark);
    line-height: 1.6;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
}

/* Prevent scroll when modal is open */
body.modal-open {
    overflow: hidden;
}

/* ============================== */
/* LOGIN PAGE STYLES */
/* ============================== */
.login-page { 
    min-height: 100vh; 
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    display: flex; 
    align-items: center; 
    justify-content: center; 
    padding: 2rem; 
}

.login-container { 
    background: white; 
    border-radius: 20px; 
    box-shadow: 0 20px 40px rgba(0,0,0,0.3); 
    overflow: hidden; 
    display: flex; 
    min-width: 1000px; 
    min-height: 600px; 
}

.login-left { 
    flex: 1; 
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    display: flex; 
    flex-direction: column; 
    justify-content: center; 
    align-items: center; 
    color: white; 
    padding: 3rem; 
    text-align: center; 
}

.logo-circle { 
    width: 100px; 
    height: 100px; 
    background: white; 
    border-radius: 50%; 
    display: flex; 
    align-items: center; 
    justify-content: center; 
    font-weight: bold; 
    color: #667eea; 
    font-size: 40px; 
    margin-bottom: 1rem; 
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

.company-title { 
    font-size: 3rem; 
    font-weight: bold; 
    margin-bottom: 0.5rem; 
}

.company-subtitle { 
    font-size: 1.2rem; 
    opacity: 0.9; 
}

.login-right { 
    flex: 1; 
    padding: 3rem; 
    display: flex; 
    flex-direction: column; 
    justify-content: center; 
}

.tabs { 
    display: flex; 
    gap: 1rem; 
    margin-bottom: 2rem; 
    border-bottom: 2px solid var(--border); 
}

.tab { 
    padding: 1rem 2rem; 
    cursor: pointer; 
    background: none; 
    border: none; 
    font-size: 1rem; 
    font-weight: 600; 
    color: var(--text-light); 
    transition: all 0.3s; 
    border-bottom: 3px solid transparent; 
    margin-bottom: -2px; 
}

.tab.active { 
    color: #667eea; 
    border-bottom-color: #667eea; 
}

.form-container { 
    display: none; 
}

.form-container.active { 
    display: block; 
}

.form-group { 
    margin-bottom: 1.5rem; 
}

.form-group label { 
    display: block; 
    margin-bottom: 0.5rem; 
    font-weight: 500; 
    color: var(--text-dark); 
}

.form-group input, 
.form-group select, 
.form-group textarea { 
    width: 100%; 
    padding: 0.75rem; 
    border: 2px solid var(--border); 
    border-radius: 8px; 
    font-size: 1rem; 
    transition: all 0.3s; 
}

.form-group input:focus, 
.form-group select:focus, 
.form-group textarea:focus { 
    outline: none; 
    border-color: #667eea; 
}

.password-requirements {
    margin-top: 0.5rem;
    padding: 0.75rem;
    background: #f0f4f8;
    border-radius: 8px;
    font-size: 0.875rem;
}

.password-requirements strong {
    display: block;
    margin-bottom: 0.5rem;
    color: var(--text-dark);
}

.password-requirements ul {
    margin: 0.5rem 0 0 1.5rem;
    line-height: 1.8;
    color: var(--text-dark);
}

.password-example {
    margin-top: 0.5rem;
    padding: 0.5rem;
    background: #dbeafe;
    border-radius: 4px;
    color: #1e40af;
}

.password-example code {
    background: white;
    padding: 2px 6px;
    border-radius: 3px;
    font-family: 'Courier New', monospace;
}

.role-selector { 
    display: grid; 
    grid-template-columns: repeat(2, 1fr); 
    gap: 1rem; 
}

.role-btn { 
    padding: 1rem; 
    border: 2px solid var(--border); 
    background: white; 
    border-radius: 8px; 
    cursor: pointer; 
    transition: all 0.3s; 
    text-align: center; 
    font-weight: 500; 
}

.role-btn:hover { 
    border-color: #667eea; 
    background: #f0f4ff; 
}

.role-btn.active { 
    border-color: #667eea; 
    background: #667eea; 
    color: white; 
}

.btn { 
    padding: 0.75rem 2rem; 
    border: none; 
    border-radius: 8px; 
    font-size: 1rem; 
    font-weight: 600; 
    cursor: pointer; 
    transition: all 0.3s; 
}

.btn-primary { 
    background: linear-gradient(135deg, #667eea, #764ba2); 
    color: white; 
    width: 100%; 
}

.btn-primary:hover { 
    transform: translateY(-2px); 
    box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3); 
}

.message { 
    padding: 1rem; 
    border-radius: 8px; 
    margin-bottom: 1rem; 
    display: none; 
}

.message.info { 
    background: #dbeafe; 
    color: #1e40af; 
    display: block; 
}

.message.success { 
    background: #d1fae5; 
    color: #065f46; 
    display: block; 
}

.message.error { 
    background: #fee2e2; 
    color: #991b1b; 
    display: block; 
}

/* App Container Styles */
#appContainer {
    display: none;
    min-height: 100vh;
    background: var(--background);
}

.app-header {
    background: white;
    box-shadow: var(--card-shadow);
    padding: 1rem 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: sticky;
    top: 0;
    z-index: 100;
}

.app-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--primary-blue);
}

.user-info {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.logout-btn {
    background: var(--danger);
    color: white;
    padding: 0.5rem 1rem;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
}

.app-main {
    display: flex;
    min-height: calc(100vh - 70px);
}

.sidebar {
    width: 250px;
    background: white;
    box-shadow: var(--card-shadow);
    padding: 2rem 0;
}

.menu-item {
    padding: 1rem 2rem;
    cursor: pointer;
    transition: all 0.3s;
    border-left: 4px solid transparent;
}

.menu-item:hover {
    background: var(--light-blue);
    border-left-color: var(--primary-blue);
}

.menu-item.active {
    background: var(--light-blue);
    border-left-color: var(--primary-blue);
    font-weight: 600;
    color: var(--primary-blue);
}

.content {
    flex: 1;
    padding: 2rem;
}

.card {
    background: white;
    border-radius: 12px;
    padding: 2rem;
    box-shadow: var(--card-shadow);
    margin-bottom: 2rem;
}

.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 9999;
}

.loading-overlay.active {
    display: flex;
}

.spinner {
    width: 50px;
    height: 50px;
    border: 5px solid rgba(255, 255, 255, 0.3);
    border-top-color: white;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.data-table {
    width: 100%;
    border-collapse: collapse;
}

.data-table th,
.data-table td {
    padding: 1rem;
    text-align: left;
    border-bottom: 1px solid var(--border);
}

.data-table th {
    background: var(--light-blue);
    font-weight: 600;
    color: var(--primary-blue);
}

.status-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.875rem;
    font-weight: 600;
}

.status-pending {
    background: #fef3c7;
    color: #92400e;
}

.status-active {
    background: #d1fae5;
    color: #065f46;
}

.status-completed {
    background: #dbeafe;
    color: #1e40af;
}

/* Modal Styles */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

.modal-overlay.active {
    display: flex;
}

.modal-content {
    background: white;
    border-radius: 12px;
    max-width: 800px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
}

.modal-header {
    padding: 1.5rem 2rem;
    border-bottom: 2px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-body {
    padding: 2rem;
}

.close-modal {
    font-size: 2rem;
    cursor: pointer;
    color: var(--text-light);
}

.close-modal:hover {
    color: var(--danger);
}

    </style>
</head>
<body>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
    </div>

    <!-- Login/Register Page -->
    <div class="login-page" id="loginPage">
        <div class="login-container">
            <div class="login-left">
                <div class="logo-circle">EB</div>
                <h1 class="company-title">EDANBROOK</h1>
                <p class="company-subtitle">Project Management Platform</p>
            </div>
            <div class="login-right">
                <div class="tabs">
                    <button class="tab active" onclick="showTab('login')">Login</button>
                    <button class="tab" onclick="showTab('register')">Register</button>
                </div>

                <div id="messageContainer"></div>

                <!-- Login Form -->
                <div id="loginForm" class="form-container active">
                    <form onsubmit="handleLogin(event)">
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="loginEmail" required placeholder="your@email.com">
                        </div>
                        <div class="form-group">
                            <label>Password</label>
                            <input type="password" id="loginPassword" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                        </div>
                        <button type="submit" class="btn btn-primary">Login</button>
                    </form>
                </div>

                <!-- Register Form -->
                <div id="registerForm" class="form-container">
                    <form onsubmit="handleRegister(event)">
                        <div class="form-group">
                            <label>Full Name</label>
                            <input type="text" id="registerName" required placeholder="John Doe">
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="registerEmail" required placeholder="your@email.com">
                        </div>
                        <div class="form-group">
                            <label>Password</label>
                            <input 
                                type="password" 
                                id="registerPassword" 
                                required 
                                placeholder="Enter strong password"
                                oninput="showPasswordStrength(this.value)"
                            >
                            <div id="passwordStrength" style="margin-top: 0.5rem; font-size: 0.875rem;"></div>
                            <div class="password-requirements">
                                <strong>Password Requirements:</strong>
                                <ul>
                                    <li>Minimum 8 characters</li>
                                    <li>One uppercase letter (A-Z)</li>
                                    <li>One lowercase letter (a-z)</li>
                                    <li>One number (0-9)</li>
                                    <li>One special character (!@#$%^&*)</li>
                                </ul>
                                <div class="password-example">
                                    <strong>‚úì Valid Example:</strong> <code>TestPass123!</code>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Select Role</label>
                            <div class="role-selector">
                                <div class="role-btn" data-role="bdm" onclick="selectRole('bdm')">BDM</div>
                                <div class="role-btn" data-role="estimator" onclick="selectRole('estimator')">Estimator</div>
                                <div class="role-btn" data-role="coo" onclick="selectRole('coo')">COO</div>
                                <div class="role-btn" data-role="director" onclick="selectRole('director')">Director</div>
                                <div class="role-btn" data-role="design_lead" onclick="selectRole('design_lead')">Design Manager</div>
                                <div class="role-btn" data-role="designer" onclick="selectRole('designer')">Designer</div>
                            </div>
                            <input type="hidden" id="selectedRole" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Create Account</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="appContainer">
        <div class="app-header">
            <div class="app-title">üèóÔ∏è EBTracker</div>
            <div class="user-info">
                <span id="userWelcome">Welcome, <strong id="userName"></strong></span>
                <span class="status-badge" id="userRole"></span>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
        </div>

        <div class="app-main">
            <div class="sidebar">
                <div class="menu-item active" onclick="showView('dashboard')">üìä Dashboard</div>
                <div class="menu-item" onclick="showView('proposals')">üìù Proposals</div>
                <div class="menu-item" onclick="showView('projects')">üèóÔ∏è Projects</div>
                <div class="menu-item" onclick="showView('timesheet')">‚è±Ô∏è Timesheet</div>
                <div class="menu-item" onclick="showView('users')">üë• Users</div>
            </div>

            <div class="content">
                <div id="viewContainer">
                    <!-- Dynamic content loads here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // AWS API & AUTH CONFIGURATION - FIXED
        // ============================================

        // CRITICAL FIX: Removed trailing slash from API URL
        const API_BASE = 'https://w7qzsempf3.execute-api.ap-south-1.amazonaws.com/production';
        console.log('üîß AWS Backend URL configured:', API_BASE);

        // Current user state
        let currentUser = null;
        let currentUserRole = '';
        let authToken = '';

        // API Configuration
        const API_CONFIG = {
            BASE_URL: API_BASE,
            TIMEOUT: 30000, // 30 seconds
            MAX_RETRIES: 3,
            RETRY_DELAY: 1000,
            RETRY_STATUS_CODES: [502, 503, 504, 408]
        };

        // ============================================
        // PASSWORD VALIDATION - NEW
        // ============================================
        function validatePassword(password) {
            const errors = [];
            
            if (password.length < 8) {
                errors.push('at least 8 characters');
            }
            if (!/[A-Z]/.test(password)) {
                errors.push('one uppercase letter (A-Z)');
            }
            if (!/[a-z]/.test(password)) {
                errors.push('one lowercase letter (a-z)');
            }
            if (!/[0-9]/.test(password)) {
                errors.push('one number (0-9)');
            }
            if (!/[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password)) {
                errors.push('one special character (!@#$%^&*)');
            }
            
            return errors;
        }

        function showPasswordStrength(password) {
            const strengthIndicator = document.getElementById('passwordStrength');
            if (!strengthIndicator) return;
            
            if (!password) {
                strengthIndicator.innerHTML = '';
                return;
            }
            
            const errors = validatePassword(password);
            if (errors.length === 0) {
                strengthIndicator.innerHTML = '<span style="color: #10b981; font-weight: 600;">‚úì Strong password</span>';
            } else {
                strengthIndicator.innerHTML = `<span style="color: #ef4444;">‚úó Password needs: ${errors.join(', ')}</span>`;
            }
        }

        // ============================================
        // CORE API FUNCTION
        // ============================================
        async function apiCall(endpoint, options = {}, retryCount = 0) {
            const MAX_RETRIES = API_CONFIG.MAX_RETRIES;
            const url = `${API_CONFIG.BASE_URL}/api/${endpoint}`;

            // Prepare headers
            const defaultHeaders = {
                'Accept': 'application/json'
            };

            if (authToken && !endpoint.includes('login') && !endpoint.includes('register')) {
                defaultHeaders['Authorization'] = `Bearer ${authToken}`;
            }

            // Don't set Content-Type for FormData
            if (!(options.body instanceof FormData)) {
                defaultHeaders['Content-Type'] = 'application/json';
            }

            const finalOptions = {
                method: options.method || 'GET',
                ...options,
                headers: { ...defaultHeaders, ...(options.headers || {}) },
                mode: 'cors',
                credentials: 'omit'
            };

            // Add timeout
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), API_CONFIG.TIMEOUT);
            finalOptions.signal = controller.signal;

            try {
                console.log(`üì§ API Call [${finalOptions.method}]: ${url}`);
                
                const response = await fetch(url, finalOptions);
                clearTimeout(timeoutId);
                
                console.log(`üì• Response: ${response.status} ${response.statusText}`);

                // Parse response
                const contentType = response.headers.get('content-type');
                let responseData;

                if (contentType && contentType.includes('application/json')) {
                    const responseText = await response.text();
                    try {
                        responseData = responseText ? JSON.parse(responseText) : {};
                    } catch (parseError) {
                        console.error('‚ùå JSON parse error:', parseError);
                        throw new Error(`Invalid JSON response from server`);
                    }
                } else {
                    responseData = await response.text();
                }

                // Handle error responses
                if (!response.ok) {
                    if (response.status === 401) {
                        console.error('‚ùå 401 Unauthorized');
                        authToken = '';
                        currentUser = null;
                        showLogin();
                        throw new Error('Session expired. Please log in again.');
                    }

                    // Handle AWS Gateway errors with retry
                    if (API_CONFIG.RETRY_STATUS_CODES.includes(response.status) && retryCount < MAX_RETRIES) {
                        const delay = API_CONFIG.RETRY_DELAY * Math.pow(2, retryCount);
                        console.warn(`‚ö†Ô∏è AWS Gateway error ${response.status}, retrying in ${delay}ms...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        return await apiCall(endpoint, options, retryCount + 1);
                    }

                    const errorMessage = responseData.error || 
                                       responseData.message || 
                                       `Request failed with status ${response.status}`;
                    
                    console.error(`‚ùå API Error: ${errorMessage}`);
                    throw new Error(errorMessage);
                }

                console.log('‚úÖ API call successful');
                
                // Handle AWS Lambda response format
                if (responseData && typeof responseData === 'object') {
                    if (responseData.success === false) {
                        throw new Error(responseData.error || responseData.message || 'API request failed');
                    }
                    
                    if ('success' in responseData) {
                        return responseData;
                    }
                    
                    return { success: true, data: responseData };
                }
                
                return { success: true, data: responseData };

            } catch (error) {
                clearTimeout(timeoutId);
                console.error(`‚ùå API call to ${endpoint} failed:`, error);

                // Handle timeout errors
                if (error.name === 'AbortError') {
                    if (retryCount < MAX_RETRIES) {
                        const delay = API_CONFIG.RETRY_DELAY * Math.pow(2, retryCount);
                        console.warn(`‚ö†Ô∏è Timeout, retrying in ${delay}ms...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        return await apiCall(endpoint, options, retryCount + 1);
                    }
                    throw new Error('Request timeout. Please try again.');
                }

                // Handle network errors
                if (error.message.includes('Failed to fetch')) {
                    const detailedError = 
                        `‚ùå Cannot connect to backend!\n\n` +
                        `Backend URL: ${API_CONFIG.BASE_URL}\n\n` +
                        `Possible issues:\n` +
                        `‚Ä¢ Backend is not deployed\n` +
                        `‚Ä¢ CORS is not configured correctly\n` +
                        `‚Ä¢ API Gateway is unavailable\n` +
                        `‚Ä¢ Network connectivity problem\n\n` +
                        `Check browser console for details.`;
                    
                    console.error('‚ùå ' + detailedError);
                    throw new Error('Cannot connect to backend');
                }

                throw error;
            }
        }

        // ============================================
        // BACKEND HEALTH CHECK
        // ============================================
        async function checkBackendHealth() {
            try {
                console.log('üîç Checking AWS backend health...');
                const response = await fetch(`${API_CONFIG.BASE_URL}/api/health`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' },
                    mode: 'cors'
                });
                
                if (response.ok) {
                    console.log('‚úÖ AWS Backend is healthy and reachable');
                    return true;
                } else {
                    console.warn(`‚ö†Ô∏è Backend responded with status: ${response.status}`);
                    return false;
                }
            } catch (error) {
                console.error('‚ùå Backend health check failed:', error);
                console.error(`   Backend URL: ${API_CONFIG.BASE_URL}`);
                return false;
            }
        }

        // ============================================
        // AUTHENTICATION FUNCTIONS - UPDATED
        // ============================================
        async function handleLogin(e) {
            e.preventDefault();
            
            const email = document.getElementById('loginEmail').value.toLowerCase().trim();
            const password = document.getElementById('loginPassword').value;

            if (!email || !password) {
                return showMessage('Email and password are required', 'error');
            }

            try {
                clearMessages();
                showMessage('Logging in...', 'info');
                
                console.log('üîê Attempting login for:', email);
                
                const response = await apiCall('auth/login', {
                    method: 'POST',
                    body: JSON.stringify({ email, password })
                });
                
                if (response.success && response.token) {
                    console.log('‚úÖ Login successful');
                    
                    // Store auth token
                    authToken = response.token;
                    
                    // Store user info
                    currentUser = response.data;
                    currentUserRole = response.data.role;
                    
                    // Store in localStorage for persistence
                    localStorage.setItem('authToken', authToken);
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    
                    showMessage('Login successful!', 'success');
                    setTimeout(() => showApp(), 500);
                } else {
                    throw new Error(response.error || response.message || 'Login failed');
                }
            } catch (error) {
                console.error('‚ùå Login error:', error);
                let errorMessage = error.message;
                
                // Make error messages user-friendly
                if (errorMessage.includes('Invalid credentials') || errorMessage.includes('incorrect')) {
                    errorMessage = 'Invalid email or password. Please try again.';
                } else if (errorMessage.includes('not found')) {
                    errorMessage = 'No account found with this email. Please register first.';
                } else if (errorMessage.includes('not active')) {
                    errorMessage = 'Your account is not active. Please contact administrator.';
                }
                
                showMessage(errorMessage, 'error');
            }
        }

        async function handleRegister(e) {
            e.preventDefault();
            
            const name = document.getElementById('registerName').value.trim();
            const email = document.getElementById('registerEmail').value.toLowerCase().trim();
            const password = document.getElementById('registerPassword').value;
            const role = document.getElementById('selectedRole').value;

            // Validation
            if (!name || !email || !password || !role) {
                return showMessage('All fields are required', 'error');
            }

            // Email validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                return showMessage('Please enter a valid email address', 'error');
            }

            // Password validation - CHECK BEFORE SENDING TO BACKEND
            const passwordErrors = validatePassword(password);
            if (passwordErrors.length > 0) {
                return showMessage(`Password must have: ${passwordErrors.join(', ')}`, 'error');
            }

            try {
                clearMessages();
                showMessage('Creating account...', 'info');
                
                console.log('üìù Attempting registration for:', email);
                
                const response = await apiCall('auth/register', {
                    method: 'POST',
                    body: JSON.stringify({ name, email, password, role })
                });
                
                if (response.success) {
                    console.log('‚úÖ Registration successful');
                    showMessage('‚úÖ Account created successfully! Please log in.', 'success');
                    
                    // Clear form
                    document.getElementById('registerForm').reset();
                    document.getElementById('selectedRole').value = '';
                    document.querySelectorAll('.role-btn').forEach(btn => btn.classList.remove('active'));
                    
                    // Switch to login tab after 2 seconds
                    setTimeout(() => {
                        const loginTab = document.querySelector('.tab:first-child');
                        loginTab.click();
                    }, 2000);
                } else {
                    throw new Error(response.error || response.message || 'Registration failed');
                }
            } catch (error) {
                console.error('‚ùå Registration error:', error);
                let errorMessage = error.message;
                
                // Make error messages user-friendly
                if (errorMessage.includes('already exists')) {
                    errorMessage = '‚ö†Ô∏è An account with this email already exists. Please log in.';
                } else if (!errorMessage.includes('Password')) {
                    errorMessage = '‚ùå Registration failed: ' + errorMessage;
                }
                
                showMessage(errorMessage, 'error');
            }
        }

        function logout() {
            authToken = '';
            currentUser = null;
            currentUserRole = '';
            localStorage.removeItem('authToken');
            localStorage.removeItem('currentUser');
            console.log('üëã User logged out');
            showLogin();
        }

        // ============================================
        // UI HELPER FUNCTIONS
        // ============================================
        function showTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.form-container').forEach(f => f.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tab + 'Form').classList.add('active');
            
            clearMessages();
        }

        function selectRole(role) {
            document.querySelectorAll('.role-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('selectedRole').value = role;
        }

        function showMessage(text, type) {
            const container = document.getElementById('messageContainer');
            container.innerHTML = `<div class="message ${type}">${text}</div>`;
        }

        function clearMessages() {
            document.getElementById('messageContainer').innerHTML = '';
        }

        function showLogin() {
            document.getElementById('loginPage').style.display = 'flex';
            document.getElementById('appContainer').style.display = 'none';
        }

        function showApp() {
            console.log('--- showApp() EXECUTING ---');
            try {
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('appContainer').style.display = 'block';
                
                // Update user info in header
                if (currentUser) {
                    document.getElementById('userName').textContent = currentUser.name;
                    document.getElementById('userRole').textContent = currentUserRole.replace('_', ' ').toUpperCase();
                }
                
                // Load dashboard by default
                showView('dashboard');
                
                console.log('‚úÖ App UI displayed successfully');
            } catch (error) {
                console.error('‚ùå Error in showApp():', error);
            }
        }

        function showLoading() {
            document.getElementById('loadingOverlay').classList.add('active');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('active');
        }

        // ============================================
        // VIEW NAVIGATION
        // ============================================
        async function showView(view) {
            console.log(`üìç Navigating to view: ${view}`);
            
            // Update active menu item
            document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
            event.target.classList.add('active');
            
            const viewContainer = document.getElementById('viewContainer');
            
            try {
                showLoading();
                
                switch(view) {
                    case 'dashboard':
                        await loadDashboard();
                        break;
                    case 'proposals':
                        await loadProposals();
                        break;
                    case 'projects':
                        await loadProjects();
                        break;
                    case 'timesheet':
                        await loadTimesheet();
                        break;
                    case 'users':
                        await loadUsers();
                        break;
                    default:
                        viewContainer.innerHTML = '<div class="card"><h2>View not found</h2></div>';
                }
            } catch (error) {
                console.error(`‚ùå Error loading ${view}:`, error);
                viewContainer.innerHTML = `
                    <div class="card">
                        <h2>Error Loading ${view}</h2>
                        <p style="color: var(--danger);">${error.message}</p>
                        <button class="btn btn-primary" onclick="showView('${view}')">Retry</button>
                    </div>
                `;
            } finally {
                hideLoading();
            }
        }

        // ============================================
        // DASHBOARD VIEW
        // ============================================
        async function loadDashboard() {
            console.log('üìä Loading dashboard...');
            
            const response = await apiCall('dashboard');
            
            if (!response.success) {
                throw new Error('Failed to load dashboard');
            }
            
            const data = response.data || {};
            
            const viewContainer = document.getElementById('viewContainer');
            viewContainer.innerHTML = `
                <div class="card">
                    <h2>üìä Dashboard</h2>
                    <p>Welcome back, <strong>${currentUser.name}</strong>!</p>
                    <p>Role: <span class="status-badge status-active">${currentUserRole.replace('_', ' ').toUpperCase()}</span></p>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                    <div class="card" style="text-align: center;">
                        <h3 style="color: var(--text-light);">Total Proposals</h3>
                        <div style="font-size: 3rem; font-weight: 700; color: var(--primary-blue);">
                            ${data.totalProposals || 0}
                        </div>
                    </div>
                    <div class="card" style="text-align: center;">
                        <h3 style="color: var(--text-light);">Active Projects</h3>
                        <div style="font-size: 3rem; font-weight: 700; color: var(--success);">
                            ${data.activeProjects || 0}
                        </div>
                    </div>
                    <div class="card" style="text-align: center;">
                        <h3 style="color: var(--text-light);">Pending Tasks</h3>
                        <div style="font-size: 3rem; font-weight: 700; color: var(--warning);">
                            ${data.pendingTasks || 0}
                        </div>
                    </div>
                </div>
            `;
            
            console.log('‚úÖ Dashboard loaded successfully');
        }

        // ============================================
        // PROPOSALS VIEW
        // ============================================
        async function loadProposals() {
            console.log('üìù Loading proposals...');
            
            const response = await apiCall('proposals');
            
            if (!response.success) {
                throw new Error('Failed to load proposals');
            }
            
            const proposals = response.data || [];
            
            const viewContainer = document.getElementById('viewContainer');
            viewContainer.innerHTML = `
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <h2>üìù Proposals</h2>
                        <button class="btn btn-primary" onclick="createNewProposal()">+ New Proposal</button>
                    </div>
                    
                    ${proposals.length === 0 ? 
                        '<p style="text-align: center; padding: 2rem; color: var(--text-light);">No proposals found</p>' :
                        `<table class="data-table">
                            <thead>
                                <tr>
                                    <th>Proposal ID</th>
                                    <th>Client</th>
                                    <th>Status</th>
                                    <th>Created Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${proposals.map(p => `
                                    <tr>
                                        <td>${p.id || 'N/A'}</td>
                                        <td>${p.clientCompany || 'N/A'}</td>
                                        <td><span class="status-badge status-${p.status || 'pending'}">${p.status || 'Pending'}</span></td>
                                        <td>${formatDate(p.createdAt)}</td>
                                        <td>
                                            <button class="btn btn-primary" style="padding: 0.5rem 1rem;" onclick="viewProposal('${p.id}')">View</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>`
                    }
                </div>
            `;
            
            console.log('‚úÖ Proposals loaded successfully');
        }

        // ============================================
        // PROJECTS VIEW
        // ============================================
        async function loadProjects() {
            console.log('üèóÔ∏è Loading projects...');
            
            const response = await apiCall('projects');
            
            if (!response.success) {
                throw new Error('Failed to load projects');
            }
            
            const projects = response.data || [];
            
            const viewContainer = document.getElementById('viewContainer');
            viewContainer.innerHTML = `
                <div class="card">
                    <h2>üèóÔ∏è Projects</h2>
                    
                    ${projects.length === 0 ? 
                        '<p style="text-align: center; padding: 2rem; color: var(--text-light);">No projects found</p>' :
                        `<table class="data-table">
                            <thead>
                                <tr>
                                    <th>Project ID</th>
                                    <th>Name</th>
                                    <th>Status</th>
                                    <th>Start Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${projects.map(p => `
                                    <tr>
                                        <td>${p.id || 'N/A'}</td>
                                        <td>${p.name || 'N/A'}</td>
                                        <td><span class="status-badge status-${p.status || 'active'}">${p.status || 'Active'}</span></td>
                                        <td>${formatDate(p.startDate)}</td>
                                        <td>
                                            <button class="btn btn-primary" style="padding: 0.5rem 1rem;" onclick="viewProject('${p.id}')">View</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>`
                    }
                </div>
            `;
            
            console.log('‚úÖ Projects loaded successfully');
        }

        // ============================================
        // TIMESHEET VIEW
        // ============================================
        async function loadTimesheet() {
            console.log('‚è±Ô∏è Loading timesheet...');
            
            const viewContainer = document.getElementById('viewContainer');
            viewContainer.innerHTML = `
                <div class="card">
                    <h2>‚è±Ô∏è Timesheet</h2>
                    <p>Timesheet functionality coming soon...</p>
                </div>
            `;
            
            console.log('‚úÖ Timesheet view loaded');
        }

        // ============================================
        // USERS VIEW
        // ============================================
        async function loadUsers() {
            console.log('üë• Loading users...');
            
            const response = await apiCall('users');
            
            if (!response.success) {
                throw new Error('Failed to load users');
            }
            
            const users = response.data || [];
            
            const viewContainer = document.getElementById('viewContainer');
            viewContainer.innerHTML = `
                <div class="card">
                    <h2>üë• Users</h2>
                    
                    ${users.length === 0 ? 
                        '<p style="text-align: center; padding: 2rem; color: var(--text-light);">No users found</p>' :
                        `<table class="data-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Role</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${users.map(u => `
                                    <tr>
                                        <td>${u.name || 'N/A'}</td>
                                        <td>${u.email || 'N/A'}</td>
                                        <td><span class="status-badge status-active">${u.role || 'N/A'}</span></td>
                                        <td><span class="status-badge status-${u.status || 'active'}">${u.status || 'Active'}</span></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>`
                    }
                </div>
            `;
            
            console.log('‚úÖ Users loaded successfully');
        }

        // ============================================
        // HELPER FUNCTIONS
        // ============================================
        function formatDate(date) {
            if (!date) return 'N/A';
            
            // Handle AWS DynamoDB timestamps
            if (typeof date === 'number') {
                return new Date(date).toLocaleDateString();
            }
            
            // Handle ISO strings
            if (typeof date === 'string') {
                return new Date(date).toLocaleDateString();
            }
            
            // Handle objects with seconds property (Firestore style)
            if (date.seconds) {
                return new Date(date.seconds * 1000).toLocaleDateString();
            }
            
            return 'N/A';
        }

        // Placeholder functions for actions
        function createNewProposal() {
            alert('Create new proposal functionality coming soon!');
        }

        function viewProposal(id) {
            alert(`View proposal ${id} - Coming soon!`);
        }

        function viewProject(id) {
            alert(`View project ${id} - Coming soon!`);
        }

        // ============================================
        // APP INITIALIZATION
        // ============================================
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üöÄ Application starting...');
            console.log('Backend URL:', API_BASE);
            
            // Check for existing auth token
            const savedToken = localStorage.getItem('authToken');
            const savedUser = localStorage.getItem('currentUser');
            
            if (savedToken && savedUser) {
                console.log('üìù Found saved session');
                authToken = savedToken;
                currentUser = JSON.parse(savedUser);
                currentUserRole = currentUser.role;
                
                // Verify token is still valid
                try {
                    const response = await apiCall('dashboard');
                    if (response.success) {
                        console.log('‚úÖ Session restored successfully');
                        showApp();
                        return;
                    }
                } catch (error) {
                    console.log('‚ö†Ô∏è Saved session expired');
                    localStorage.removeItem('authToken');
                    localStorage.removeItem('currentUser');
                }
            }
            
            // Show login page
            showLogin();
            
            // Check backend health
            setTimeout(async () => {
                const isHealthy = await checkBackendHealth();
                if (!isHealthy) {
                    console.warn('‚ö†Ô∏è WARNING: Cannot reach AWS backend');
                    showMessage('Warning: Backend server is not responding. Some features may not work.', 'error');
                }
            }, 1000);
        });
    </script>

</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="manifest" href="/manifest.json" />
    <meta name="theme-color" content="#0d47a1">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EBTracker - EDANBROOK Project Management</title>
    <style>
     * { margin: 0; padding: 0; box-sizing: border-box; }

:root {
    /* Professional Light Color Palette */
    --primary-blue: #1e40af;
    --dark-blue: #1e3a8a;
    --light-blue: #dbeafe;
    --accent-blue: #3b82f6;
    --text-dark: #1f2937;
    --text-light: #6b7280;
    --background: #f0f4f8;
    --success: #10b981;
    --danger: #ef4444;
    --warning: #f59e0b;
    --border: #e5e7eb;
    --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    --card-shadow-hover: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
    background: linear-gradient(135deg, #f0f4f8 0%, #e6eef5 100%);
    color: var(--text-dark);
    line-height: 1.6;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
}

/* Prevent scroll when modal is open */
body.modal-open {
    overflow: hidden;
}

/* ============================== */
/* LOGIN PAGE STYLES */
/* ============================== */
.login-page { 
    min-height: 100vh; 
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    display: flex; 
    align-items: center; 
    justify-content: center; 
    padding: 2rem; 
}

.login-container { 
    background: white; 
    border-radius: 20px; 
    box-shadow: 0 20px 40px rgba(0,0,0,0.3); 
    overflow: hidden; 
    display: flex; 
    min-width: 1000px; 
    min-height: 600px; 
}

.login-left { 
    flex: 1; 
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    display: flex; 
    flex-direction: column; 
    justify-content: center; 
    align-items: center; 
    color: white; 
    padding: 3rem; 
    text-align: center; 
}

.logo-circle { 
    width: 100px; 
    height: 100px; 
    background: white; 
    border-radius: 50%; 
    display: flex; 
    align-items: center; 
    justify-content: center; 
    font-weight: bold; 
    color: #667eea; 
    font-size: 40px; 
    margin-bottom: 1rem; 
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

.company-title { 
    font-size: 3rem; 
    font-weight: bold; 
    margin-bottom: 0.5rem; 
}

.company-subtitle { 
    font-size: 1.2rem; 
    opacity: 0.9; 
}

.login-right { 
    flex: 1; 
    padding: 3rem; 
    display: flex; 
    flex-direction: column; 
    justify-content: center; 
}

.tabs { 
    display: flex; 
    gap: 1rem; 
    margin-bottom: 2rem; 
}

.tab { 
    flex: 1; 
    padding: 1rem; 
    text-align: center; 
    cursor: pointer; 
    border-bottom: 3px solid transparent; 
    font-weight: 600; 
    color: var(--text-light); 
    transition: all 0.3s; 
}

.tab.active { 
    color: #667eea; 
    border-bottom-color: #667eea; 
}

.form-container { 
    display: none; 
}

.form-container.active { 
    display: block; 
}

.form-group { 
    margin-bottom: 1.5rem; 
}

.form-group label { 
    display: block; 
    margin-bottom: 0.5rem; 
    font-weight: 600; 
    color: var(--text-dark); 
}

.form-group input { 
    width: 100%; 
    padding: 0.875rem; 
    border: 2px solid var(--border); 
    border-radius: 8px; 
    font-size: 1rem; 
    transition: all 0.3s; 
}

.form-group input:focus { 
    outline: none; 
    border-color: #667eea; 
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); 
}

.role-selection { 
    display: grid; 
    grid-template-columns: repeat(3, 1fr); 
    gap: 0.5rem; 
    margin-top: 0.5rem; 
}

.role-btn { 
    padding: 0.75rem; 
    border: 2px solid var(--border); 
    border-radius: 8px; 
    background: white; 
    cursor: pointer; 
    font-weight: 600; 
    transition: all 0.3s; 
    text-align: center; 
}

.role-btn:hover { 
    border-color: #667eea; 
    color: #667eea; 
}

.role-btn.active { 
    background: #667eea; 
    border-color: #667eea; 
    color: white; 
}

.btn { 
    width: 100%; 
    padding: 1rem; 
    border: none; 
    border-radius: 8px; 
    font-size: 1rem; 
    font-weight: 600; 
    cursor: pointer; 
    transition: all 0.3s; 
}

.btn-primary { 
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white; 
}

.btn-primary:hover { 
    transform: translateY(-2px); 
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4); 
}

.message { 
    padding: 1rem; 
    border-radius: 8px; 
    margin-bottom: 1rem; 
    font-weight: 500; 
}

.message.error { 
    background: #fee2e2; 
    color: #dc2626; 
}

.message.success { 
    background: #d1fae5; 
    color: #059669; 
}

.message.info { 
    background: #dbeafe; 
    color: #2563eb; 
}

/* ============================== */
/* APP CONTAINER STYLES */
/* ============================== */
.app-container {
    display: none;
    min-height: 100vh;
}

.header {
    background: white;
    padding: 1rem 2rem;
    box-shadow: var(--card-shadow);
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: sticky;
    top: 0;
    z-index: 100;
}

.header-left {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.app-logo {
    font-size: 1.5rem;
    font-weight: bold;
    color: var(--primary-blue);
}

.header-right {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.user-info {
    text-align: right;
}

.user-name {
    font-weight: 600;
    color: var(--text-dark);
}

.user-role {
    font-size: 0.875rem;
    color: var(--text-light);
}

.btn-logout {
    padding: 0.5rem 1.5rem;
    background: var(--danger);
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s;
}

.btn-logout:hover {
    background: #dc2626;
    transform: translateY(-2px);
}

.main-container {
    display: flex;
    min-height: calc(100vh - 80px);
}

.sidebar {
    width: 250px;
    background: white;
    box-shadow: var(--card-shadow);
    padding: 2rem 0;
}

.menu-item {
    padding: 1rem 2rem;
    cursor: pointer;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    color: var(--text-dark);
    font-weight: 500;
}

.menu-item:hover {
    background: var(--light-blue);
    color: var(--primary-blue);
}

.menu-item.active {
    background: var(--light-blue);
    color: var(--primary-blue);
    border-left: 4px solid var(--primary-blue);
}

.content {
    flex: 1;
    padding: 2rem;
    overflow-y: auto;
}

.card {
    background: white;
    border-radius: 12px;
    padding: 2rem;
    box-shadow: var(--card-shadow);
    margin-bottom: 2rem;
}

.card h2 {
    margin-bottom: 1.5rem;
    color: var(--text-dark);
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.stat-card {
    background: white;
    padding: 1.5rem;
    border-radius: 12px;
    box-shadow: var(--card-shadow);
    transition: all 0.3s;
}

.stat-card:hover {
    box-shadow: var(--card-shadow-hover);
    transform: translateY(-4px);
}

.stat-number {
    font-size: 2.5rem;
    font-weight: bold;
    color: var(--primary-blue);
    margin: 0.5rem 0;
}

.stat-label {
    color: var(--text-light);
    font-size: 0.875rem;
}

.data-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 1rem;
}

.data-table th {
    background: var(--light-blue);
    padding: 1rem;
    text-align: left;
    font-weight: 600;
    color: var(--text-dark);
    border-bottom: 2px solid var(--border);
}

.data-table td {
    padding: 1rem;
    border-bottom: 1px solid var(--border);
}

.data-table tr:hover {
    background: var(--light-blue);
}

.status-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 12px;
    font-size: 0.875rem;
    font-weight: 600;
}

.status-pending {
    background: #fef3c7;
    color: #92400e;
}

.status-approved, .status-active {
    background: #d1fae5;
    color: #065f46;
}

.status-rejected, .status-cancelled {
    background: #fee2e2;
    color: #991b1b;
}

.status-completed {
    background: #dbeafe;
    color: #1e40af;
}

.status-on_hold {
    background: #e5e7eb;
    color: #374151;
}

.loading-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    align-items: center;
    justify-content: center;
}

.loading-overlay.active {
    display: flex;
}

.loading-spinner {
    border: 4px solid #f3f3f3;
    border-top: 4px solid var(--primary-blue);
    border-radius: 50%;
    width: 50px;
    height: 50px;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.btn-action {
    padding: 0.5rem 1rem;
    margin: 0 0.25rem;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s;
}

.btn-view {
    background: var(--accent-blue);
    color: white;
}

.btn-edit {
    background: var(--warning);
    color: white;
}

.btn-delete {
    background: var(--danger);
    color: white;
}

.btn-action:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}

/* Modal Styles */
.modal {
    display: none;
    position: fixed;
    z-index: 2000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    overflow-y: auto;
}

.modal.active {
    display: block;
}

.modal-content {
    background-color: white;
    margin: 5% auto;
    padding: 2rem;
    border-radius: 12px;
    width: 90%;
    max-width: 800px;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
    position: relative;
}

.modal-close {
    position: absolute;
    right: 1.5rem;
    top: 1.5rem;
    font-size: 2rem;
    font-weight: bold;
    cursor: pointer;
    color: var(--text-light);
    transition: color 0.3s;
}

.modal-close:hover {
    color: var(--danger);
}

.form-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1.5rem;
    margin-top: 1.5rem;
}

.form-grid-full {
    grid-column: 1 / -1;
}

textarea {
    width: 100%;
    padding: 0.875rem;
    border: 2px solid var(--border);
    border-radius: 8px;
    font-size: 1rem;
    font-family: inherit;
    resize: vertical;
    min-height: 100px;
}

textarea:focus {
    outline: none;
    border-color: var(--primary-blue);
    box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1);
}

select {
    width: 100%;
    padding: 0.875rem;
    border: 2px solid var(--border);
    border-radius: 8px;
    font-size: 1rem;
    background: white;
    cursor: pointer;
}

select:focus {
    outline: none;
    border-color: var(--primary-blue);
    box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1);
}

/* Responsive Design */
@media (max-width: 1024px) {
    .login-container {
        min-width: auto;
        flex-direction: column;
    }

    .form-grid {
        grid-template-columns: 1fr;
    }

    .sidebar {
        width: 200px;
    }
}

@media (max-width: 768px) {
    .stats-grid {
        grid-template-columns: 1fr;
    }

    .main-container {
        flex-direction: column;
    }

    .sidebar {
        width: 100%;
    }
}
    </style>
</head>
<body>

    <!-- Login Page -->
    <div id="loginPage" class="login-page">
        <div class="login-container">
            <div class="login-left">
                <div class="logo-circle">EB</div>
                <div class="company-title">EDANBROOK</div>
                <div class="company-subtitle">Project Management System</div>
            </div>
            <div class="login-right">
                <div class="tabs">
                    <div class="tab active" onclick="showTab('login')">Login</div>
                    <div class="tab" onclick="showTab('register')">Register</div>
                </div>
                
                <div id="messageContainer"></div>
                
                <!-- Login Form -->
                <div id="loginForm" class="form-container active">
                    <form onsubmit="handleLogin(event)">
                        <div class="form-group">
                            <label for="loginEmail">Email Address</label>
                            <input type="email" id="loginEmail" placeholder="your.email@example.com" required>
                        </div>
                        <div class="form-group">
                            <label for="loginPassword">Password</label>
                            <input type="password" id="loginPassword" placeholder="Enter your password" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Login</button>
                    </form>
                </div>
                
                <!-- Register Form -->
                <div id="registerForm" class="form-container">
                    <form onsubmit="handleRegister(event)">
                        <div class="form-group">
                            <label for="registerName">Full Name</label>
                            <input type="text" id="registerName" placeholder="John Doe" required>
                        </div>
                        <div class="form-group">
                            <label for="registerEmail">Email Address</label>
                            <input type="email" id="registerEmail" placeholder="your.email@example.com" required>
                        </div>
                        <div class="form-group">
                            <label for="registerPassword">Password</label>
                            <input type="password" id="registerPassword" placeholder="Create a strong password" required oninput="showPasswordStrength(this.value)">
                            <div id="passwordStrength" style="margin-top: 0.5rem; font-size: 0.875rem;"></div>
                        </div>
                        <div class="form-group">
                            <label>Select Your Role</label>
                            <input type="hidden" id="selectedRole">
                            <div class="role-selection">
                                <div class="role-btn" onclick="selectRole('coo')">COO</div>
                                <div class="role-btn" onclick="selectRole('director')">Director</div>
                                <div class="role-btn" onclick="selectRole('bdm')">BDM</div>
                                <div class="role-btn" onclick="selectRole('estimator')">Estimator</div>
                                <div class="role-btn" onclick="selectRole('design_manager')">Design Manager</div>
                                <div class="role-btn" onclick="selectRole('designer')">Designer</div>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">Create Account</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="appContainer" class="app-container">
        <div class="header">
            <div class="header-left">
                <div class="app-logo">üìä EBTracker</div>
            </div>
            <div class="header-right">
                <div class="user-info">
                    <div class="user-name" id="userName">Loading...</div>
                    <div class="user-role" id="userRole">Role</div>
                </div>
                <button class="btn-logout" onclick="logout()">Logout</button>
            </div>
        </div>
        
        <div class="main-container">
            <div class="sidebar">
                <div class="menu-item active" onclick="showView('dashboard')">üìä Dashboard</div>
                <div class="menu-item" onclick="showView('proposals')">üìã Proposals</div>
                <div class="menu-item" onclick="showView('projects')">üèóÔ∏è Projects</div>
                <div class="menu-item" onclick="showView('timesheet')">‚è±Ô∏è Timesheet</div>
                <div class="menu-item" onclick="showView('users')">üë• Users</div>
                <div class="menu-item" onclick="showView('notifications')">üîî Notifications</div>
                <div class="menu-item" onclick="showView('activities')">üìù Activities</div>
            </div>
            
            <div class="content">
                <div id="viewContainer">
                    <!-- Dynamic content loads here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
    </div>

    <script>
        // ============================================
        // AWS API & AUTH CONFIGURATION
        // ============================================

        // AWS Backend URL - Update this with your actual API Gateway URL
        const API_BASE = 'https://w7qzsempf3.execute-api.ap-south-1.amazonaws.com/production';
        console.log('üîß AWS Backend URL configured:', API_BASE);

        // Current user state
        let currentUser = null;
        let currentUserRole = '';
        let authToken = '';

        // API Configuration
        const API_CONFIG = {
            BASE_URL: API_BASE,
            TIMEOUT: 30000, // 30 seconds
            MAX_RETRIES: 3,
            RETRY_DELAY: 1000,
            RETRY_STATUS_CODES: [502, 503, 504, 408]
        };

        // ============================================
        // PASSWORD VALIDATION
        // ============================================
        function validatePassword(password) {
            const errors = [];
            
            if (password.length < 8) {
                errors.push('at least 8 characters');
            }
            if (!/[A-Z]/.test(password)) {
                errors.push('one uppercase letter (A-Z)');
            }
            if (!/[a-z]/.test(password)) {
                errors.push('one lowercase letter (a-z)');
            }
            if (!/[0-9]/.test(password)) {
                errors.push('one number (0-9)');
            }
            if (!/[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password)) {
                errors.push('one special character (!@#$%^&*)');
            }
            
            return errors;
        }

        function showPasswordStrength(password) {
            const strengthIndicator = document.getElementById('passwordStrength');
            if (!strengthIndicator) return;
            
            if (!password) {
                strengthIndicator.innerHTML = '';
                return;
            }
            
            const errors = validatePassword(password);
            if (errors.length === 0) {
                strengthIndicator.innerHTML = '<span style="color: #10b981; font-weight: 600;">‚úì Strong password</span>';
            } else {
                strengthIndicator.innerHTML = `<span style="color: #ef4444;">‚úó Password needs: ${errors.join(', ')}</span>`;
            }
        }

        // ============================================
        // CORE API FUNCTION
        // ============================================
        async function apiCall(endpoint, options = {}, retryCount = 0) {
            const MAX_RETRIES = API_CONFIG.MAX_RETRIES;
            const url = `${API_CONFIG.BASE_URL}/api/${endpoint}`;

            // Prepare headers
            const defaultHeaders = {
                'Accept': 'application/json'
            };

            if (authToken && !endpoint.includes('login') && !endpoint.includes('register')) {
                defaultHeaders['Authorization'] = `Bearer ${authToken}`;
            }

            // Don't set Content-Type for FormData
            if (!(options.body instanceof FormData)) {
                defaultHeaders['Content-Type'] = 'application/json';
            }

            const finalOptions = {
                method: options.method || 'GET',
                ...options,
                headers: { ...defaultHeaders, ...(options.headers || {}) },
                mode: 'cors',
                credentials: 'omit'
            };

            // Add timeout
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), API_CONFIG.TIMEOUT);
            finalOptions.signal = controller.signal;

            try {
                console.log(`üì§ API Call [${finalOptions.method}]: ${url}`);
                
                const response = await fetch(url, finalOptions);
                clearTimeout(timeoutId);
                
                console.log(`üì• Response: ${response.status} ${response.statusText}`);

                // Parse response
                const contentType = response.headers.get('content-type');
                let responseData;

                if (contentType && contentType.includes('application/json')) {
                    const responseText = await response.text();
                    try {
                        responseData = responseText ? JSON.parse(responseText) : {};
                    } catch (parseError) {
                        console.error('‚ùå JSON parse error:', parseError);
                        throw new Error(`Invalid JSON response from server`);
                    }
                } else {
                    responseData = await response.text();
                }

                // Handle error responses
                if (!response.ok) {
                    if (response.status === 401) {
                        console.error('‚ùå 401 Unauthorized');
                        authToken = '';
                        currentUser = null;
                        showLogin();
                        throw new Error('Session expired. Please log in again.');
                    }

                    // Handle AWS Gateway errors with retry
                    if (API_CONFIG.RETRY_STATUS_CODES.includes(response.status) && retryCount < MAX_RETRIES) {
                        const delay = API_CONFIG.RETRY_DELAY * Math.pow(2, retryCount);
                        console.warn(`‚ö†Ô∏è AWS Gateway error ${response.status}, retrying in ${delay}ms...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        return await apiCall(endpoint, options, retryCount + 1);
                    }

                    const errorMessage = responseData.error || 
                                       responseData.message || 
                                       `Request failed with status ${response.status}`;
                    
                    console.error(`‚ùå API Error: ${errorMessage}`);
                    throw new Error(errorMessage);
                }

                console.log('‚úÖ API call successful');
                
                // Handle AWS Lambda response format
                if (responseData && typeof responseData === 'object') {
                    if (responseData.success === false) {
                        throw new Error(responseData.error || responseData.message || 'API request failed');
                    }
                    
                    if ('success' in responseData) {
                        return responseData;
                    }
                    
                    return { success: true, data: responseData };
                }
                
                return { success: true, data: responseData };

            } catch (error) {
                clearTimeout(timeoutId);
                console.error(`‚ùå API call to ${endpoint} failed:`, error);

                // Handle timeout errors
                if (error.name === 'AbortError') {
                    if (retryCount < MAX_RETRIES) {
                        const delay = API_CONFIG.RETRY_DELAY * Math.pow(2, retryCount);
                        console.warn(`‚ö†Ô∏è Timeout, retrying in ${delay}ms...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        return await apiCall(endpoint, options, retryCount + 1);
                    }
                    throw new Error('Request timeout. Please try again.');
                }

                // Handle network errors
                if (error.message.includes('Failed to fetch')) {
                    const detailedError = 
                        `‚ùå Cannot connect to backend!\n\n` +
                        `Backend URL: ${API_CONFIG.BASE_URL}\n\n` +
                        `Possible issues:\n` +
                        `‚Ä¢ Backend is not deployed\n` +
                        `‚Ä¢ CORS is not configured correctly\n` +
                        `‚Ä¢ API Gateway is unavailable\n` +
                        `‚Ä¢ Network connectivity problem\n\n` +
                        `Check browser console for details.`;
                    
                    console.error('‚ùå ' + detailedError);
                    throw new Error('Cannot connect to backend');
                }

                throw error;
            }
        }

        // ============================================
        // BACKEND HEALTH CHECK
        // ============================================
        async function checkBackendHealth() {
            try {
                console.log('üîç Checking AWS backend health...');
                const response = await fetch(`${API_CONFIG.BASE_URL}/api/health`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' },
                    mode: 'cors'
                });
                
                if (response.ok) {
                    console.log('‚úÖ AWS Backend is healthy and reachable');
                    return true;
                } else {
                    console.warn(`‚ö†Ô∏è Backend responded with status: ${response.status}`);
                    return false;
                }
            } catch (error) {
                console.error('‚ùå Backend health check failed:', error);
                console.error(`   Backend URL: ${API_CONFIG.BASE_URL}`);
                return false;
            }
        }

        // ============================================
        // AUTHENTICATION FUNCTIONS
        // ============================================
        async function handleLogin(e) {
            e.preventDefault();
            
            const email = document.getElementById('loginEmail').value.toLowerCase().trim();
            const password = document.getElementById('loginPassword').value;

            if (!email || !password) {
                return showMessage('Email and password are required', 'error');
            }

            try {
                clearMessages();
                showMessage('Logging in...', 'info');
                
                console.log('üîê Attempting login for:', email);
                
                const response = await apiCall('auth/login', {
                    method: 'POST',
                    body: JSON.stringify({ email, password })
                });
                
                if (response.success) {
                    console.log('‚úÖ Login successful');
                    
                    // Store auth token and user data
                    authToken = response.token;
                    currentUser = response.user;
                    currentUserRole = response.user.role;
                    
                    localStorage.setItem('authToken', authToken);
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    
                    console.log('User logged in:', currentUser);
                    
                    // Show app
                    showApp();
                } else {
                    throw new Error(response.error || response.message || 'Login failed');
                }
            } catch (error) {
                console.error('‚ùå Login error:', error);
                showMessage('‚ùå ' + error.message, 'error');
            }
        }

        async function handleRegister(e) {
            e.preventDefault();
            
            const name = document.getElementById('registerName').value.trim();
            const email = document.getElementById('registerEmail').value.toLowerCase().trim();
            const password = document.getElementById('registerPassword').value;
            const role = document.getElementById('selectedRole').value;

            // Validation
            if (!name || !email || !password || !role) {
                return showMessage('All fields are required', 'error');
            }

            // Email validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                return showMessage('Please enter a valid email address', 'error');
            }

            // Password validation
            const passwordErrors = validatePassword(password);
            if (passwordErrors.length > 0) {
                return showMessage(`Password must have: ${passwordErrors.join(', ')}`, 'error');
            }

            try {
                clearMessages();
                showMessage('Creating account...', 'info');
                
                console.log('üìù Attempting registration for:', email);
                
                const response = await apiCall('auth/register', {
                    method: 'POST',
                    body: JSON.stringify({ name, email, password, role })
                });
                
                if (response.success) {
                    console.log('‚úÖ Registration successful');
                    showMessage('‚úÖ Account created successfully! Please log in.', 'success');
                    
                    // Clear form
                    document.getElementById('registerName').value = '';
                    document.getElementById('registerEmail').value = '';
                    document.getElementById('registerPassword').value = '';
                    document.getElementById('selectedRole').value = '';
                    document.getElementById('passwordStrength').innerHTML = '';
                    document.querySelectorAll('.role-btn').forEach(btn => btn.classList.remove('active'));
                    
                    // Switch to login tab after 2 seconds
                    setTimeout(() => {
                        const loginTab = document.querySelector('.tab:first-child');
                        loginTab.click();
                    }, 2000);
                } else {
                    throw new Error(response.error || response.message || 'Registration failed');
                }
            } catch (error) {
                console.error('‚ùå Registration error:', error);
                let errorMessage = error.message;
                
                // Make error messages user-friendly
                if (errorMessage.includes('already exists')) {
                    errorMessage = '‚ö†Ô∏è An account with this email already exists. Please log in.';
                } else if (!errorMessage.includes('Password')) {
                    errorMessage = '‚ùå Registration failed: ' + errorMessage;
                }
                
                showMessage(errorMessage, 'error');
            }
        }

        function logout() {
            authToken = '';
            currentUser = null;
            currentUserRole = '';
            localStorage.removeItem('authToken');
            localStorage.removeItem('currentUser');
            console.log('üëã User logged out');
            showLogin();
        }

        // ============================================
        // UI HELPER FUNCTIONS
        // ============================================
        function showTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.form-container').forEach(f => f.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tab + 'Form').classList.add('active');
            
            clearMessages();
        }

        function selectRole(role) {
            document.querySelectorAll('.role-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('selectedRole').value = role;
        }

        function showMessage(text, type) {
            const container = document.getElementById('messageContainer');
            container.innerHTML = `<div class="message ${type}">${text}</div>`;
        }

        function clearMessages() {
            document.getElementById('messageContainer').innerHTML = '';
        }

        function showLogin() {
            document.getElementById('loginPage').style.display = 'flex';
            document.getElementById('appContainer').style.display = 'none';
        }

        function showApp() {
            console.log('--- showApp() EXECUTING ---');
            try {
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('appContainer').style.display = 'block';
                
                // Update user info in header
                if (currentUser) {
                    document.getElementById('userName').textContent = currentUser.name;
                    document.getElementById('userRole').textContent = currentUserRole.replace('_', ' ').toUpperCase();
                }
                
                // Load dashboard by default
                loadDashboard();
                
                console.log('‚úÖ App UI displayed successfully');
            } catch (error) {
                console.error('‚ùå Error in showApp():', error);
            }
        }

        function showLoading() {
            document.getElementById('loadingOverlay').classList.add('active');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('active');
        }

        // ============================================
        // VIEW NAVIGATION
        // ============================================
        async function showView(view) {
            console.log(`üìç Navigating to view: ${view}`);
            
            // Update active menu item
            document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
            if (event && event.target) {
                event.target.classList.add('active');
            }
            
            const viewContainer = document.getElementById('viewContainer');
            
            try {
                showLoading();
                
                switch(view) {
                    case 'dashboard':
                        await loadDashboard();
                        break;
                    case 'proposals':
                        await loadProposals();
                        break;
                    case 'projects':
                        await loadProjects();
                        break;
                    case 'timesheet':
                        await loadTimesheet();
                        break;
                    case 'users':
                        await loadUsers();
                        break;
                    case 'notifications':
                        await loadNotifications();
                        break;
                    case 'activities':
                        await loadActivities();
                        break;
                    default:
                        viewContainer.innerHTML = '<div class="card"><h2>View not found</h2></div>';
                }
            } catch (error) {
                console.error(`‚ùå Error loading ${view}:`, error);
                viewContainer.innerHTML = `
                    <div class="card">
                        <h2>Error Loading ${view}</h2>
                        <p style="color: var(--danger);">${error.message}</p>
                        <button class="btn btn-primary" onclick="showView('${view}')">Retry</button>
                    </div>
                `;
            } finally {
                hideLoading();
            }
        }

        // ============================================
        // DASHBOARD VIEW
        // ============================================
        async function loadDashboard() {
            console.log('üìä Loading dashboard...');
            
            try {
                const response = await apiCall('dashboard/stats');
                
                if (!response.success) {
                    throw new Error('Failed to load dashboard');
                }
                
                const stats = response.data || {};
                
                const viewContainer = document.getElementById('viewContainer');
                viewContainer.innerHTML = `
                    <h1 style="margin-bottom: 2rem;">Dashboard</h1>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-label">Total Projects</div>
                            <div class="stat-number">${stats.projects?.total || 0}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Active Projects</div>
                            <div class="stat-number">${stats.projects?.active || 0}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Total Proposals</div>
                            <div class="stat-number">${stats.proposals?.total || 0}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Pending Proposals</div>
                            <div class="stat-number">${stats.proposals?.pending || 0}</div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h2>Recent Activity</h2>
                        <p style="color: var(--text-light);">Activity tracking coming soon...</p>
                    </div>
                `;
                
                console.log('‚úÖ Dashboard loaded successfully');
            } catch (error) {
                console.error('‚ùå Error loading dashboard:', error);
                throw error;
            }
        }

        // ============================================
        // PROPOSALS VIEW
        // ============================================
        async function loadProposals() {
            console.log('üìã Loading proposals...');
            
            const response = await apiCall('proposals');
            
            if (!response.success) {
                throw new Error('Failed to load proposals');
            }
            
            const proposals = response.data || [];
            
            const viewContainer = document.getElementById('viewContainer');
            viewContainer.innerHTML = `
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h2>üìã Proposals</h2>
                        <button class="btn btn-primary" style="width: auto; padding: 0.75rem 1.5rem;" onclick="createNewProposal()">+ New Proposal</button>
                    </div>
                    
                    ${proposals.length === 0 ? 
                        '<p style="text-align: center; padding: 2rem; color: var(--text-light);">No proposals found</p>' :
                        `<table class="data-table">
                            <thead>
                                <tr>
                                    <th>Proposal ID</th>
                                    <th>Title</th>
                                    <th>Client</th>
                                    <th>Status</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${proposals.map(p => `
                                    <tr>
                                        <td>${p.proposalId || 'N/A'}</td>
                                        <td>${p.title || 'N/A'}</td>
                                        <td>${p.clientName || 'N/A'}</td>
                                        <td><span class="status-badge status-${p.status || 'pending'}">${p.status || 'Pending'}</span></td>
                                        <td>${formatDate(p.createdAt)}</td>
                                        <td>
                                            <button class="btn-action btn-view" onclick="viewProposal('${p.proposalId}')">View</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>`
                    }
                </div>
            `;
            
            console.log('‚úÖ Proposals loaded successfully');
        }

        // ============================================
        // PROJECTS VIEW
        // ============================================
        async function loadProjects() {
            console.log('üèóÔ∏è Loading projects...');
            
            const response = await apiCall('projects');
            
            if (!response.success) {
                throw new Error('Failed to load projects');
            }
            
            const projects = response.data || [];
            
            const viewContainer = document.getElementById('viewContainer');
            viewContainer.innerHTML = `
                <div class="card">
                    <h2>üèóÔ∏è Projects</h2>
                    
                    ${projects.length === 0 ? 
                        '<p style="text-align: center; padding: 2rem; color: var(--text-light);">No projects found</p>' :
                        `<table class="data-table">
                            <thead>
                                <tr>
                                    <th>Project ID</th>
                                    <th>Name</th>
                                    <th>Status</th>
                                    <th>Start Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${projects.map(p => `
                                    <tr>
                                        <td>${p.projectId || 'N/A'}</td>
                                        <td>${p.name || 'N/A'}</td>
                                        <td><span class="status-badge status-${p.status || 'active'}">${p.status || 'Active'}</span></td>
                                        <td>${formatDate(p.startDate)}</td>
                                        <td>
                                            <button class="btn-action btn-view" onclick="viewProject('${p.projectId}')">View</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>`
                    }
                </div>
            `;
            
            console.log('‚úÖ Projects loaded successfully');
        }

        // ============================================
        // TIMESHEET VIEW
        // ============================================
        async function loadTimesheet() {
            console.log('‚è±Ô∏è Loading timesheet...');
            
            const response = await apiCall('timesheets');
            
            if (!response.success) {
                throw new Error('Failed to load timesheets');
            }
            
            const timesheets = response.data || [];
            
            const viewContainer = document.getElementById('viewContainer');
            viewContainer.innerHTML = `
                <div class="card">
                    <h2>‚è±Ô∏è Timesheet</h2>
                    
                    ${timesheets.length === 0 ? 
                        '<p style="text-align: center; padding: 2rem; color: var(--text-light);">No timesheet entries found</p>' :
                        `<table class="data-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Project</th>
                                    <th>Hours</th>
                                    <th>Description</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${timesheets.map(t => `
                                    <tr>
                                        <td>${formatDate(t.date)}</td>
                                        <td>${t.projectName || 'N/A'}</td>
                                        <td>${t.hours || 0}</td>
                                        <td>${t.description || 'N/A'}</td>
                                        <td><span class="status-badge status-${t.status || 'pending'}">${t.status || 'Pending'}</span></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>`
                    }
                </div>
            `;
            
            console.log('‚úÖ Timesheet loaded successfully');
        }

        // ============================================
        // USERS VIEW
        // ============================================
        async function loadUsers() {
            console.log('üë• Loading users...');
            
            const response = await apiCall('users');
            
            if (!response.success) {
                throw new Error('Failed to load users');
            }
            
            const users = response.data || [];
            
            const viewContainer = document.getElementById('viewContainer');
            viewContainer.innerHTML = `
                <div class="card">
                    <h2>üë• Users</h2>
                    
                    ${users.length === 0 ? 
                        '<p style="text-align: center; padding: 2rem; color: var(--text-light);">No users found</p>' :
                        `<table class="data-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Role</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${users.map(u => `
                                    <tr>
                                        <td>${u.name || 'N/A'}</td>
                                        <td>${u.email || 'N/A'}</td>
                                        <td><span class="status-badge status-active">${u.role || 'N/A'}</span></td>
                                        <td><span class="status-badge status-${u.status || 'active'}">${u.status || 'Active'}</span></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>`
                    }
                </div>
            `;
            
            console.log('‚úÖ Users loaded successfully');
        }

        // ============================================
        // NOTIFICATIONS VIEW
        // ============================================
        async function loadNotifications() {
            console.log('üîî Loading notifications...');
            
            const response = await apiCall('notifications');
            
            if (!response.success) {
                throw new Error('Failed to load notifications');
            }
            
            const notifications = response.data || [];
            
            const viewContainer = document.getElementById('viewContainer');
            viewContainer.innerHTML = `
                <div class="card">
                    <h2>üîî Notifications</h2>
                    
                    ${notifications.length === 0 ? 
                        '<p style="text-align: center; padding: 2rem; color: var(--text-light);">No notifications</p>' :
                        `<div style="display: flex; flex-direction: column; gap: 1rem;">
                            ${notifications.map(n => `
                                <div style="padding: 1rem; border-left: 4px solid ${n.read ? '#e5e7eb' : '#3b82f6'}; background: ${n.read ? '#f9fafb' : '#eff6ff'}; border-radius: 8px;">
                                    <div style="font-weight: 600; margin-bottom: 0.5rem;">${n.title || 'Notification'}</div>
                                    <div style="color: var(--text-light); font-size: 0.875rem;">${n.message || 'No message'}</div>
                                    <div style="color: var(--text-light); font-size: 0.75rem; margin-top: 0.5rem;">${formatDate(n.createdAt)}</div>
                                </div>
                            `).join('')}
                        </div>`
                    }
                </div>
            `;
            
            console.log('‚úÖ Notifications loaded successfully');
        }

        // ============================================
        // ACTIVITIES VIEW
        // ============================================
        async function loadActivities() {
            console.log('üìù Loading activities...');
            
            const response = await apiCall('activities');
            
            if (!response.success) {
                throw new Error('Failed to load activities');
            }
            
            const activities = response.data || [];
            
            const viewContainer = document.getElementById('viewContainer');
            viewContainer.innerHTML = `
                <div class="card">
                    <h2>üìù Recent Activities</h2>
                    
                    ${activities.length === 0 ? 
                        '<p style="text-align: center; padding: 2rem; color: var(--text-light);">No activities</p>' :
                        `<table class="data-table">
                            <thead>
                                <tr>
                                    <th>Action</th>
                                    <th>User</th>
                                    <th>Description</th>
                                    <th>Time</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${activities.map(a => `
                                    <tr>
                                        <td>${a.action || 'N/A'}</td>
                                        <td>${a.userName || 'N/A'}</td>
                                        <td>${a.description || 'N/A'}</td>
                                        <td>${formatDate(a.timestamp)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>`
                    }
                </div>
            `;
            
            console.log('‚úÖ Activities loaded successfully');
        }

        // ============================================
        // HELPER FUNCTIONS
        // ============================================
        function formatDate(date) {
            if (!date) return 'N/A';
            
            // Handle AWS DynamoDB timestamps
            if (typeof date === 'number') {
                return new Date(date * 1000).toLocaleDateString();
            }
            
            // Handle ISO strings
            if (typeof date === 'string') {
                return new Date(date).toLocaleDateString();
            }
            
            // Handle objects with seconds property
            if (date.seconds) {
                return new Date(date.seconds * 1000).toLocaleDateString();
            }
            
            return 'N/A';
        }

        // Placeholder functions for actions
        function createNewProposal() {
            alert('Create new proposal functionality coming soon!');
        }

        function viewProposal(id) {
            alert(`View proposal ${id} - Coming soon!`);
        }

        function viewProject(id) {
            alert(`View project ${id} - Coming soon!`);
        }

        // ============================================
        // APP INITIALIZATION
        // ============================================
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üöÄ Application starting...');
            console.log('Backend URL:', API_BASE);
            
            // Check for existing auth token
            const savedToken = localStorage.getItem('authToken');
            const savedUser = localStorage.getItem('currentUser');
            
            if (savedToken && savedUser) {
                console.log('üìù Found saved session');
                authToken = savedToken;
                currentUser = JSON.parse(savedUser);
                currentUserRole = currentUser.role;
                
                // Verify token is still valid
                try {
                    const response = await apiCall('dashboard/stats');
                    if (response.success) {
                        console.log('‚úÖ Session restored successfully');
                        showApp();
                        return;
                    }
                } catch (error) {
                    console.log('‚ö†Ô∏è Saved session expired');
                    localStorage.removeItem('authToken');
                    localStorage.removeItem('currentUser');
                }
            }
            
            // Show login page
            showLogin();
            
            // Check backend health
            setTimeout(async () => {
                const isHealthy = await checkBackendHealth();
                if (!isHealthy) {
                    console.warn('‚ö†Ô∏è WARNING: Cannot reach AWS backend');
                    showMessage('Warning: Backend server is not responding. Some features may not work.', 'error');
                }
            }, 1000);
        });
    </script>

</body>
</html>
